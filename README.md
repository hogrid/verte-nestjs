# agents.md

Instru√ß√µes para Agentes de IA trabalhando na migra√ß√£o Laravel ‚Üí NestJS do projeto Verte.

---

## üéØ Objetivo do Projeto

**Migrar o backend Verte de Laravel 8 para NestJS 10 mantendo compatibilidade 100%.**

Este √© um projeto de **MIGRA√á√ÉO**, n√£o de reescrita. O frontend e o banco de dados **N√ÉO DEVEM SER ALTERADOS**.

---

## üö® Regras Cr√≠ticas Inviol√°veis

### 1. CONSULTA OBRIGAT√ìRIA AO PROJETO ORIGINAL

**SEMPRE consulte o projeto Laravel localizado em `../verte-back/` antes de implementar qualquer funcionalidade.**

```bash
# Estrutura de diret√≥rios:
workspace/
‚îú‚îÄ‚îÄ verte-back/          # Projeto Laravel ORIGINAL (fonte da verdade)
‚îÇ   ‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îî‚îÄ‚îÄ docs/migration/  # Documenta√ß√£o master
‚îÇ
‚îî‚îÄ‚îÄ verte-nestjs/        # Projeto NestJS NOVO (este reposit√≥rio)
    ‚îú‚îÄ‚îÄ src/
    ‚îú‚îÄ‚îÄ test/
    ‚îî‚îÄ‚îÄ docs/            # C√≥pia da documenta√ß√£o
```

### 2. COMPATIBILIDADE 100% OBRIGAT√ìRIA

| Item | Obriga√ß√£o |
|------|-----------|
| **Rotas** | URIs id√™nticas (todas as 121 rotas) |
| **Banco de Dados** | MESMO banco, MESMAS tabelas (22+) |
| **Responses** | Estrutura JSON id√™ntica |
| **Valida√ß√µes** | Mensagens em portugu√™s id√™nticas |
| **Status Codes** | C√≥digos HTTP id√™nticos (200, 201, 422, etc.) |
| **Autentica√ß√£o** | Tokens JWT compat√≠veis com Sanctum |
| **Relacionamentos** | Mesmos relacionamentos do Eloquent |

### 3. IMPACTO ZERO NO FRONTEND

O frontend **N√ÉO DEVE PRECISAR DE NENHUMA ALTERA√á√ÉO** para funcionar com a API NestJS.

---

## üìã Workflow de Desenvolvimento

### Processo de Implementa√ß√£o de Qualquer Funcionalidade

```mermaid
graph TD
    A[In√≠cio] --> B[1. Ler docs/migration/]
    B --> C[2. Consultar Laravel ../verte-back/]
    C --> D[3. Mapear Controllers/Models]
    D --> E[4. Implementar em NestJS]
    E --> F[5. Validar Compatibilidade]
    F --> G{Testes Passaram?}
    G -->|N√£o| H[Ajustar at√© compat√≠vel]
    H --> F
    G -->|Sim| I[Commit]
    I --> J[Fim]
```

### Checklist por Endpoint

Antes de marcar um endpoint como completo:

- [ ] **Documenta√ß√£o lida**: Consultar `docs/migration/routes-inventory.md`
- [ ] **Laravel consultado**: Ler controller correspondente em `../verte-back/`
- [ ] **Rota id√™ntica**: URI exatamente igual
- [ ] **Valida√ß√µes id√™nticas**: Mensagens em portugu√™s iguais
- [ ] **Response id√™ntico**: Estrutura JSON igual
- [ ] **Status codes id√™nticos**: C√≥digos HTTP iguais
- [ ] **Testes E2E escritos**: Validar compatibilidade
- [ ] **Testes passando**: 100% de compatibilidade

---

## üìö Documenta√ß√£o de Refer√™ncia

### Documentos Essenciais (Ler Antes de Come√ßar)

1. **`docs/migration/README.md`**
   - Vis√£o geral da migra√ß√£o
   - Estrat√©gia em 5 fases
   - Estat√≠sticas do projeto (121 rotas, 22+ tabelas)

2. **`docs/migration/routes-inventory.md`**
   - Invent√°rio completo de todas as 121 rotas
   - Valida√ß√µes por rota
   - Estrutura de responses

3. **`docs/migration/business-rules.md`**
   - L√≥gica de neg√≥cio detalhada
   - Fluxos de processamento
   - Regras de valida√ß√£o espec√≠ficas

4. **`docs/migration/database-schema.md`**
   - Estrutura das 22+ tabelas
   - Relacionamentos
   - Indexes e constraints

5. **`docs/migration/models-relationships.md`**
   - Modelos Laravel
   - Mapeamento para TypeORM
   - Relacionamentos preservados

6. **`docs/migration-specs/migration-master-spec.md`**
   - **REGRAS CR√çTICAS INVIOL√ÅVEIS**
   - Mapeamento Laravel ‚Üí NestJS obrigat√≥rio
   - Templates de c√≥digo

### Ordem de Leitura Recomendada

```bash
# Para come√ßar:
1. docs/migration/README.md
2. docs/migration-specs/migration-master-spec.md

# Para implementar m√≥dulo espec√≠fico:
1. docs/migration/routes-inventory.md (se√ß√£o do m√≥dulo)
2. docs/migration/business-rules.md (se√ß√£o do m√≥dulo)
3. docs/migration/models-relationships.md (models relacionados)
4. ../verte-back/app/Http/Controllers/[Controller].php
5. ../verte-back/app/Models/[Model].php
```

---

## üîç Como Consultar o Projeto Laravel

### Localiza√ß√£o de Arquivos

| Componente | Laravel (`../verte-back/`) | NestJS (este repo) |
|------------|----------------------------|-------------------|
| Controllers | `app/Http/Controllers/` | `src/[module]/[module].controller.ts` |
| Models | `app/Models/` | `src/database/entities/[model].entity.ts` |
| Requests | `app/Http/Requests/` | `src/[module]/dto/[dto].dto.ts` |
| Jobs | `app/Jobs/` | `src/[module]/processors/[job].processor.ts` |
| Middleware | `app/Http/Middleware/` | `src/common/guards/[guard].guard.ts` |
| Routes | `routes/api.php` | `src/[module]/[module].controller.ts` decorators |

### Exemplo Pr√°tico de Consulta

**Cen√°rio**: Implementar endpoint `POST /api/v1/campaigns`

```bash
# 1. Ler documenta√ß√£o
cat docs/migration/routes-inventory.md | grep -A 20 "POST /api/v1/campaigns"
cat docs/migration/business-rules.md | grep -A 50 "POST /api/v1/campaigns"

# 2. Consultar Laravel
cat ../verte-back/app/Http/Controllers/CampaignsController.php | grep -A 100 "function store"
cat ../verte-back/app/Http/Requests/StoreCampaignRequest.php
cat ../verte-back/app/Models/Campaign.php

# 3. Verificar relacionamentos
cat ../verte-back/app/Models/Campaign.php | grep "public function"

# 4. Verificar Jobs relacionados
ls ../verte-back/app/Jobs/ | grep -i campaign
```

---

## üõ†Ô∏è Padr√µes de Implementa√ß√£o

### 1. Estrutura de Controllers

```typescript
// src/campaigns/campaigns.controller.ts

import { Controller, Post, Body, UseGuards, HttpCode } from '@nestjs/common';
import { JwtAuthGuard } from '../common/guards/jwt-auth.guard';
import { CreateCampaignDto } from './dto/create-campaign.dto';

@Controller('api/v1/campaigns') // URI ID√äNTICA ao Laravel
@UseGuards(JwtAuthGuard)
export class CampaignsController {
  constructor(private readonly campaignsService: CampaignsService) {}

  @Post()
  @HttpCode(201) // Status code ID√äNTICO ao Laravel
  async store(@Body() createCampaignDto: CreateCampaignDto) {
    const campaign = await this.campaignsService.create(createCampaignDto);

    // Response ID√äNTICO ao Laravel
    return {
      data: campaign,
      message: 'Campanha criada com sucesso'
    };
  }
}
```

### 2. DTOs com Valida√ß√µes

**Consultar Laravel Request equivalente primeiro!**

```typescript
// src/campaigns/dto/create-campaign.dto.ts

// SEMPRE consultar ../verte-back/app/Http/Requests/StoreCampaignRequest.php

import { IsNotEmpty, IsString, MaxLength, IsInt, Min } from 'class-validator';

export class CreateCampaignDto {
  // Laravel: 'name' => 'required|string|max:150'
  @IsNotEmpty({ message: 'O campo nome √© obrigat√≥rio.' })
  @IsString({ message: 'O campo nome deve ser uma string.' })
  @MaxLength(150, { message: 'O campo nome n√£o pode ter mais de 150 caracteres.' })
  name: string;

  // Laravel: 'timer' => 'required|integer|min:1|max:300'
  @IsNotEmpty({ message: 'O campo timer √© obrigat√≥rio.' })
  @IsInt({ message: 'O campo timer deve ser um n√∫mero inteiro.' })
  @Min(1, { message: 'O campo timer deve ser no m√≠nimo 1.' })
  timer: number;
}
```

### 3. Entities TypeORM

**Mapear tabelas EXISTENTES, NUNCA criar novas!**

```typescript
// src/database/entities/campaign.entity.ts

// SEMPRE consultar ../verte-back/app/Models/Campaign.php
// E tamb√©m docs/migration/database-schema.md

import { Entity, PrimaryGeneratedColumn, Column, ManyToOne, OneToMany } from 'typeorm';

@Entity('campaigns') // Nome da tabela EXISTENTE no MySQL
export class Campaign {
  @PrimaryGeneratedColumn()
  id: number;

  @Column({ type: 'bigint', name: 'user_id' })
  userId: number;

  @Column({ length: 150 })
  name: string;

  // Soft deletes (como Laravel)
  @DeleteDateColumn({ name: 'deleted_at' })
  deletedAt?: Date;

  // Timestamps (como Laravel)
  @CreateDateColumn({ name: 'created_at', type: 'timestamp' })
  createdAt: Date;

  @UpdateDateColumn({ name: 'updated_at', type: 'timestamp' })
  updatedAt: Date;

  // Relacionamentos (como Eloquent)
  @ManyToOne(() => User, user => user.campaigns)
  user: User;

  @OneToMany(() => Message, message => message.campaign)
  messages: Message[];
}
```

### 4. Services com L√≥gica de Neg√≥cio

**Replicar EXATAMENTE a l√≥gica do Laravel!**

```typescript
// src/campaigns/campaigns.service.ts

// SEMPRE consultar:
// - ../verte-back/app/Http/Controllers/CampaignsController.php
// - docs/migration/business-rules.md

@Injectable()
export class CampaignsService {
  constructor(
    @InjectRepository(Campaign)
    private campaignRepository: Repository<Campaign>,
    private whatsappService: WhatsappService,
    @InjectQueue('campaigns') private campaignQueue: Queue,
  ) {}

  async create(createCampaignDto: CreateCampaignDto, userId: number) {
    // 1. Valida√ß√µes de neg√≥cio (ID√äNTICAS ao Laravel)
    const number = await this.whatsappService.getActiveNumber(userId);
    if (!number || !number.status_connection) {
      throw new BadRequestException('N√∫mero WhatsApp n√£o conectado');
    }

    // 2. Verificar limite do plano (ID√äNTICO ao Laravel)
    const user = await this.userRepository.findOne({ where: { id: userId }, relations: ['plan'] });
    const activeCampaigns = await this.campaignRepository.count({
      where: { userId, status: 0 }
    });

    if (activeCampaigns >= user.plan.limit_campaigns) {
      throw new BadRequestException('Limite de campanhas excedido para seu plano');
    }

    // 3. Criar campanha (ID√äNTICO ao Laravel)
    const campaign = this.campaignRepository.create({
      ...createCampaignDto,
      userId,
      status: createCampaignDto.schedule_date ? 3 : 0,
    });

    await this.campaignRepository.save(campaign);

    // 4. Enfileirar processamento (equivalente ao Laravel Queue)
    if (!campaign.schedule_date) {
      await this.campaignQueue.add('process-campaign', {
        campaignId: campaign.id,
        timer: createCampaignDto.timer,
      });
    }

    return campaign;
  }
}
```

---

## üß™ Testes de Compatibilidade

### Estrutura de Testes E2E

```typescript
// test/campaigns/campaigns.e2e-spec.ts

describe('Campaigns Compatibility Tests', () => {
  let app: INestApplication;

  beforeEach(async () => {
    const moduleFixture = await Test.createTestingModule({
      imports: [AppModule],
    }).compile();

    app = moduleFixture.createNestApplication();
    await app.init();
  });

  it('POST /api/v1/campaigns - should return Laravel-compatible response', async () => {
    const validData = {
      name: 'Campanha Teste',
      number_id: 1,
      public_id: 1,
      messages: [{ message: 'Ol√°!', type: 0 }],
      timer: 30
    };

    const response = await request(app.getHttpServer())
      .post('/api/v1/campaigns')
      .set('Authorization', 'Bearer valid-token')
      .send(validData)
      .expect(201);

    // Validar estrutura ID√äNTICA ao Laravel
    expect(response.body).toHaveProperty('data');
    expect(response.body).toHaveProperty('message');
    expect(response.body.message).toBe('Campanha criada com sucesso');
    expect(response.body.data).toHaveProperty('id');
    expect(response.body.data).toHaveProperty('name');
    expect(response.body.data.name).toBe(validData.name);
  });

  it('should return identical validation errors', async () => {
    const invalidData = {
      name: '', // required
      timer: 0  // min:1
    };

    const response = await request(app.getHttpServer())
      .post('/api/v1/campaigns')
      .set('Authorization', 'Bearer valid-token')
      .send(invalidData)
      .expect(422);

    // Validar mensagens ID√äNTICAS ao Laravel
    expect(response.body.message).toBe('Os dados fornecidos s√£o inv√°lidos.');
    expect(response.body.errors.name).toContain('O campo nome √© obrigat√≥rio.');
    expect(response.body.errors.timer).toContain('O campo timer deve ser no m√≠nimo 1.');
  });
});
```

---

## üìä Mapeamento de Componentes

### Laravel ‚Üí NestJS

| Laravel | NestJS | Notas |
|---------|--------|-------|
| `Route::get()` | `@Get()` decorator | URI id√™ntica |
| `Route::post()` | `@Post()` decorator | URI id√™ntica |
| `FormRequest` | DTO com `class-validator` | Mensagens id√™nticas |
| `Model::find()` | `repository.findOne()` | Mesma tabela |
| `Model::create()` | `repository.save()` | Mesma estrutura |
| `$model->save()` | `repository.save(entity)` | Mesmos campos |
| `dispatch(Job)` | `queue.add()` | Mesma l√≥gica |
| `auth:sanctum` | `@UseGuards(JwtAuthGuard)` | JWT compat√≠vel |
| `Eloquent Relations` | TypeORM Relations | Mesmos relacionamentos |
| `SoftDeletes` | `@DeleteDateColumn()` | Mesmo comportamento |
| `Event::dispatch()` | `eventEmitter.emit()` | Mesmos eventos |

### Valida√ß√µes Laravel ‚Üí NestJS

| Laravel Rule | NestJS Decorator | Mensagem |
|--------------|------------------|----------|
| `required` | `@IsNotEmpty()` | "O campo X √© obrigat√≥rio." |
| `email` | `@IsEmail()` | "O campo X deve ser um email v√°lido." |
| `min:8` | `@MinLength(8)` | "O campo X deve ter pelo menos 8 caracteres." |
| `max:255` | `@MaxLength(255)` | "O campo X n√£o pode ter mais de 255 caracteres." |
| `unique:users,email` | `@IsUnique()` custom | "O campo X j√° est√° sendo utilizado." |
| `confirmed` | `@IsConfirmed()` custom | "A confirma√ß√£o de X n√£o confere." |
| `integer` | `@IsInt()` | "O campo X deve ser um n√∫mero inteiro." |

---

## ‚ö†Ô∏è Erros Comuns a Evitar

### ‚ùå N√ÉO FA√áA

1. **Alterar URIs de rotas**
   ```typescript
   // ‚ùå ERRADO
   @Get('campaigns') // Laravel usa /api/v1/campaigns

   // ‚úÖ CORRETO
   @Get('api/v1/campaigns')
   ```

2. **Criar novas tabelas**
   ```typescript
   // ‚ùå ERRADO
   @Entity('campaigns_new') // Tabela n√£o existe no Laravel

   // ‚úÖ CORRETO
   @Entity('campaigns') // Tabela existente
   ```

3. **Alterar estrutura de responses**
   ```typescript
   // ‚ùå ERRADO
   return { success: true, result: data };

   // ‚úÖ CORRETO (como Laravel)
   return { data: data, message: 'Opera√ß√£o realizada com sucesso' };
   ```

4. **Mudar mensagens de valida√ß√£o**
   ```typescript
   // ‚ùå ERRADO
   @IsNotEmpty({ message: 'Name is required' })

   // ‚úÖ CORRETO (como Laravel)
   @IsNotEmpty({ message: 'O campo nome √© obrigat√≥rio.' })
   ```

5. **Usar diferentes status codes**
   ```typescript
   // ‚ùå ERRADO
   @HttpCode(400) // Laravel usa 422 para valida√ß√£o

   // ‚úÖ CORRETO
   @HttpCode(422)
   ```

### ‚úÖ SEMPRE FA√áA

1. **Consultar Laravel antes de implementar**
2. **Ler documenta√ß√£o em docs/migration/**
3. **Manter compatibilidade 100%**
4. **Escrever testes E2E**
5. **Validar responses id√™nticos**
6. **Preservar mensagens em portugu√™s**
7. **Usar mesmo banco de dados**

---

## üó∫Ô∏è Roadmap de Migra√ß√£o

### Fase 1: Infraestrutura (Semana 1)
- [x] Setup NestJS base
- [ ] Configurar TypeORM (mesmo banco)
- [ ] Configurar JWT (compat√≠vel com Sanctum)
- [ ] Configurar Redis
- [ ] Configurar Bull Queue

### Fase 2: Core Business (Semanas 2-3)
- [ ] M√≥dulo de Autentica√ß√£o (6 endpoints)
- [ ] M√≥dulo de Usu√°rios (13 endpoints)
- [ ] M√≥dulo de Campanhas (21 endpoints)
- [ ] M√≥dulo de Contatos (11 endpoints)

### Fase 3: Integra√ß√µes (Semana 4)
- [ ] Integra√ß√£o WAHA (15 endpoints)
- [ ] Pagamentos Stripe/MercadoPago (5 endpoints)
- [ ] Email service
- [ ] File storage

### Fase 4: Admin & Utils (Semana 5)
- [ ] Endpoints administrativos (16 endpoints)
- [ ] Planos e assinaturas (8 endpoints)
- [ ] P√∫blicos e labels (8 endpoints)
- [ ] Utilidades e testes (24 endpoints)

### Fase 5: Testes & Deploy (Semana 6)
- [ ] Testes de compatibilidade (100%)
- [ ] Performance testing
- [ ] Documentation final
- [ ] Production deployment

---

## üìû Refer√™ncias R√°pidas

### Consultar Sempre

1. **Projeto Laravel**: `../verte-back/`
2. **Docs de Migra√ß√£o**: `docs/migration/README.md`
3. **Regras Cr√≠ticas**: `docs/migration-specs/migration-master-spec.md`
4. **Invent√°rio de Rotas**: `docs/migration/routes-inventory.md`
5. **Regras de Neg√≥cio**: `docs/migration/business-rules.md`

### Comandos √öteis

```bash
# Comparar endpoint com Laravel
npm run compare:endpoint -- --route=/api/v1/login

# Testar compatibilidade
npm run test:compat

# Gerar relat√≥rio de diferen√ßas
npm run diff:report

# Ver status da migra√ß√£o
npm run migration:status
```

---

## üéØ Crit√©rios de Sucesso

Um endpoint est√° completo quando:

‚úÖ URI id√™ntica ao Laravel
‚úÖ Valida√ß√µes id√™nticas (mensagens em portugu√™s)
‚úÖ Response JSON id√™ntico
‚úÖ Status codes id√™nticos
‚úÖ Testes E2E passando 100%
‚úÖ Documentado no c√≥digo
‚úÖ Sem altera√ß√µes no banco de dados
‚úÖ Frontend funciona sem altera√ß√µes

---

## üìù Lembrete Final

üö® **Este √© um projeto de MIGRA√á√ÉO, n√£o de reescrita.**

**Objetivo**: Trocar Laravel por NestJS mantendo tudo funcionando EXATAMENTE IGUAL.

**Meta**: Frontend n√£o percebe diferen√ßa nenhuma na API.

**Quando em d√∫vida**: SEMPRE consulte `../verte-back/` e a documenta√ß√£o.

---

**Boa migra√ß√£o! üöÄ**
